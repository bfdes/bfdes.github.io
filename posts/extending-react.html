<!DOCTYPE html><html lang="en"><head><meta charSet="utf8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="theme-color" content="#202020"/><meta name="description" content="Personal blog"/><meta name="author" content="Bruno Fernandes"/><title>bfdes.in</title><link href="data:image/png;base64,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" rel="icon"/><link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Mono&amp;display=swap" rel="stylesheet"/><link href="https://unpkg.com/highlight.js@10.3.1/styles/github.css" rel="stylesheet"/><link href="https://unpkg.com/katex@0.13.9/dist/katex.min.css" rel="stylesheet"/><link href="/styles/main.css" rel="stylesheet"/></head><body><div id="root"><aside id="sidebar"><img class="avatar" src="/images/avatar.jpg" alt="Profile photo"/><div id="nav"><a class="nav-item" href="/posts"><h2>Blog</h2></a><a class="nav-item" href="/about.html"><h2>About</h2></a></div><div id="social"><a class="nav-item" href="https://www.github.com/bfdes"><img class="badge" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAYAAAA5ZDbSAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NDkxMSwgMjAxMy8xMC8yOS0xMTo0NzoxNiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RERCMUIwQTM4NkNFMTFFM0FBNTJFRTMzNTJEMUJDNDYiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RERCMUIwQTI4NkNFMTFFM0FBNTJFRTMzNTJEMUJDNDYiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkU1MTc4QTMyOTlBMDExRTI5QTE1QkMxMDQ2QTg5MDREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjJBNDE0QUJDOTlBMTExRTI5QTE1QkMxMDQ2QTg5MDREIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+8kSqyAAADD5JREFUeNrsXQ2Q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" alt="GitHub link"/></a><a class="nav-item" href="/feed.rss"><img class="badge" src="data:image/png;base64,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" alt="RSS link"/></a></div></aside><div id="content"><div class="post"><h1>Extending React</h1><p class="meta">12 May 2021 · <span> # <a href="/tags/compilers.html">Compilers</a> # <a href="/tags/jsx.html">JSX</a></span> · 988 words</p><div class="body"><p>Facebook's JavaScript user interface library ReactJS has taken the world of frontend development <a href="https://trends.google.com/trends/explore?date=2013-05-29%202021-01-01&#x26;q=%2Fm%2F012l1vxv">by storm</a> since its public introduction at <a href="https://www.youtube.com/watch?v=GW0rj4sNH2w">JSConf 2013</a>.</p>
<p>Unlike the Model-View frameworks that preceded it, React drives UI updates by declarative state management. Controversially, React introduced an XML-like syntax extension to JavaScript called <a href="https://reactjs.org/docs/introducing-jsx.html">JSX</a> so developers could combine markup syntax and render logic in application code.</p>
<p>The idioms React promoted were not initially well-received, but they have gone on to become popular.</p>
<p>We will extend React's JSX API to create a small NodeJS library that can be used in scripts to build a static website through the declarative composition of <code>File</code> and <code>Dir</code> primitives.</p>
<p>For example, part of this blog can be described by the following static router:</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">const</span> router = (
  <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Dir</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"site"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">File</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"index.html"</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">PostList</span> <span class="hljs-attr">posts</span>=<span class="hljs-string">{posts}</span> /></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">File</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">Dir</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"posts"</span>></span>
      {posts.map((post) => (
        <span class="hljs-tag">&#x3C;<span class="hljs-name">File</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">post.slug</span>}<span class="hljs-attr">.html</span>`} <span class="hljs-attr">key</span>=<span class="hljs-string">{post.slug}</span>></span>
          <span class="hljs-tag">&#x3C;<span class="hljs-name">Post</span> {<span class="hljs-attr">...post</span>} /></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">File</span>></span>
      ))}
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">Dir</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">Dir</span>></span></span>
);
</code></pre>
<p><code>router.write(__dirname)</code> writes the site to disk, mounting the files</p>
<pre><code class="hljs language-shell">site
  ├── index.html
  └── posts
      └── extending-react.html
</code></pre>
<p>in the directory where <code>write</code> was invoked.</p>
<p>In this way, anyone can roll their own React-based static site generator like <a href="https://www.gatsbyjs.com/">Gatsby</a>.</p>
<h2>Understanding React</h2>
<p>A minimal understanding of how React works is required to extend its API. Let's review some concepts.</p>
<h3>Components and Elements</h3>
<p>React applications are comprised of template entities called components.</p>
<p>They can be declared with a class or with a function.<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> For example, the following two ways of declaring a <code>Welcome</code> component that greets a user are equivalent:</p>
<pre><code class="hljs language-jsx"><span class="hljs-comment">// Class component</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Welcome</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>Hello, {this.props.name}<span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>;
  }
}

<span class="hljs-comment">// Function component</span>
<span class="hljs-keyword">const</span> Welcome = <span class="hljs-function">(<span class="hljs-params">{ name }</span>) =></span> <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>Hello, {name}<span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>;
</code></pre>
<p><code>Welcome</code> accepts a <code>name</code> property or "prop" as input, which tells it who it should greet.</p>
<p>Elements can be regarded as instances of components; they can be rendered to the DOM in a browser:</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">const</span> node = <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Welcome</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Scully"</span> /></span></span>; <span class="hljs-comment">// Instance of `Welcome` created with JSX</span>
ReactDOM.render(node, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"root"</span>));
</code></pre>
<p>, or as a string on a server:</p>
<pre><code class="hljs language-jsx">renderToStaticMarkup(<span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Welcome</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Mulder"</span> /></span></span>);
</code></pre>
<p>Note that function components and the <code>render</code> method of class components can themselves return elements -- this is not a coincidence!</p>
<h3>Composition and Children</h3>
<p>React promotes code encapsulation and reuse through composition rather than inheritance.</p>
<p>The <code>children</code> prop of a component has access to the children passed to it; this can be used to render generic components that do not know their children ahead of time. For example, a <code>Page</code> component can be used to add a common header to every page of a website:</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">const</span> Page = <span class="hljs-function">(<span class="hljs-params">{ children }</span>) =></span> (
  <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">Head</span> /></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">Body</span>></span>{children}<span class="hljs-tag">&#x3C;/<span class="hljs-name">Body</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">html</span>></span></span>
);

<span class="hljs-comment">// Usage example:</span>
<span class="hljs-keyword">const</span> About = <span class="hljs-function">() =></span> (
  <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Page</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"about"</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">h1</span>></span>About<span class="hljs-tag">&#x3C;/<span class="hljs-name">h1</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">p</span>></span>
        Hello, my name is Bruno Fernandes, and I write code for fun and profit.
      <span class="hljs-tag">&#x3C;/<span class="hljs-name">p</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">Page</span>></span></span>
);
</code></pre>
<h3>Desugaring JSX</h3>
<p>Browsers and Node cannot understand JSX, so it must be transpiled to plain JavaScript before use.</p>
<p>During transpilation, build tools such as <a href="https://babeljs.io/">Babel</a> and <a href="https://esbuild.github.io/">esbuild</a> transform any JSX tags they encounter to calls to a JSX factory function. Historically, the factory was <code>React.createElement</code>, but build tools made the factory configurable using a pragma or transpiler directive to accommodate more frameworks that support JSX.</p>
<p>For example, the script</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> Welcome = <span class="hljs-function">(<span class="hljs-params">{ name }</span>) =></span> <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>Hello, {name}<span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>;

renderToStaticMarkup(<span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Welcome</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Mulder"</span> /></span></span>);
</code></pre>
<p>could be transformed into</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> Welcome = <span class="hljs-function">(<span class="hljs-params">{ name }</span>) =></span> React.createElement(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"Hello, "</span>, name);

renderToStaticMarkup(React.createElement(Welcome, { <span class="hljs-attr">name</span>: <span class="hljs-string">"Mulder"</span> }));
</code></pre>
<p>by the first stage of a preprocessor or transpiler for React.</p>
<p>From looking at how <code>React.createElement</code> is invoked, we can learn about the expected signature for the factory function:</p>
<ul>
<li>First parameter: JSX element type. A string for lowercase types, a reference for uppercase ones.<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup></li>
<li>Second parameter: An object keyed by props passed to the element.</li>
<li>The rest of the parameters are populated with transformed child elements.</li>
</ul>
<p>Also, note that the <code>React</code> object must be in scope wherever JSX is used.<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup></p>
<h2>Writing the library</h2>
<p>We can exploit a user-customisable JSX transform and what we've seen of React's composition model to implement our API. The idea is simple: calls to <code>File</code> or <code>Dir</code> "components" should be intercepted and recast as instantiations of filesystem objects. These objects must know how to write their contents to disk recursively.</p>
<h3>The filesystem abstraction</h3>
<p>Observe that we can model files and directories on disk as trees where files form the terminal nodes. Any file or directory should be able to write its contents to disk when given a root path.</p>
<p><code>FileSystem</code> forms the notion of this interface for files and directories:</p>
<pre><code class="hljs language-js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotImplementedError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Error</span> </span>{}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileSystem</span> </span>{
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">name, content</span>)</span> {
    <span class="hljs-built_in">this</span>.name = name;
    <span class="hljs-built_in">this</span>.content = content;
  }

  <span class="hljs-function"><span class="hljs-title">write</span>(<span class="hljs-params">rootPath</span>)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotImplementedError(); <span class="hljs-comment">// Runtime interface emulation</span>
  }
}
</code></pre>
<p><code>File</code> and <code>Dir</code> implement the write behaviour:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileWriteError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Error</span> </span>{
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">filePath, ...args</span>)</span> {
    <span class="hljs-keyword">const</span> msg = <span class="hljs-string">`Could not write to <span class="hljs-subst">${filePath}</span>`</span>;
    <span class="hljs-built_in">super</span>(msg, ...args);
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FileSystem</span> </span>{
  <span class="hljs-function"><span class="hljs-title">write</span>(<span class="hljs-params">rootPath</span>)</span> {
    <span class="hljs-keyword">const</span> filePath = path.join(rootPath, <span class="hljs-built_in">this</span>.name);
    <span class="hljs-keyword">try</span> {
      fs.writeFileSync(filePath, <span class="hljs-built_in">this</span>.content);
    } <span class="hljs-keyword">catch</span> (_) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FileWriteError(filePath);
    }
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dir</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FileSystem</span> </span>{
  <span class="hljs-function"><span class="hljs-title">write</span>(<span class="hljs-params">rootPath</span>)</span> {
    <span class="hljs-keyword">const</span> dirPath = path.join(rootPath, <span class="hljs-built_in">this</span>.name);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// Create the directory if it does not exist</span>
      fs.mkdirSync(dirPath, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    } <span class="hljs-keyword">catch</span> (_) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FileWriteError(dirPath);
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fileOrDir <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.content) {
      fileOrDir.write(dirPath); <span class="hljs-comment">// recurse</span>
    }
  }
}
</code></pre>
<p>If a call to <code>write</code> fails for whatever reason, a partial write will occur. This is acceptable -- subsequent runs of the static site generator will overwrite content and remediate the problem.</p>
<h3>Hijacking the JSX transform</h3>
<p>We tell the build tool to transform JSX tags using our <em>own</em> factories:</p>
<ol>
<li>JSX elements should call <code>Template.createElement</code>, and</li>
<li>JSX fragments should expand to reference <code>Template.Fragment</code>.<sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup></li>
</ol>
<p>In Babel, this looks like</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// babel.config.js</span>
<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">presets</span>: [
    [
      <span class="hljs-string">"@babel/preset-react"</span>,
      {
        <span class="hljs-attr">pragma</span>: <span class="hljs-string">"Template.createElement"</span>,
        <span class="hljs-attr">pragmaFrag</span>: <span class="hljs-string">"Template.Fragment"</span>,
      },
    ],
  ],
};
</code></pre>
<p>Then we export some stub <code>File</code> and <code>Dir</code> components for the user to reference:</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> File = <span class="hljs-function">() =></span> <span class="xml"><span class="hljs-tag">&#x3C;></span><span class="hljs-tag">&#x3C;/></span></span>; <span class="hljs-comment">// no-op</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> Dir = <span class="hljs-function">() =></span> <span class="xml"><span class="hljs-tag">&#x3C;></span><span class="hljs-tag">&#x3C;/></span></span>; <span class="hljs-comment">// no-op</span>
</code></pre>
<p>Our JSX transformer <code>createElement</code> should intercept any <code>File</code> or <code>Dir</code> stub references and delegate all other calls to React:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> Template = {
  <span class="hljs-function"><span class="hljs-title">createElement</span>(<span class="hljs-params">type, props, ...children</span>)</span> {
    <span class="hljs-keyword">if</span> (type === Dir) {
      <span class="hljs-keyword">return</span> createDir(props, children);
    }
    <span class="hljs-keyword">if</span> (type === File) {
      <span class="hljs-keyword">return</span> createFile(props, children);
    }
    <span class="hljs-keyword">return</span> React.createElement(type, props, ...children);
  },
  <span class="hljs-attr">Fragment</span>: React.Fragment, <span class="hljs-comment">// An alias for developer convenience</span>
};
</code></pre>
<p><code>createDir</code> verifies that all children are <code>FileSystem</code> instances before creating a <code>Dir</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoutingError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Error</span> </span>{}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createDir</span>(<span class="hljs-params">props, children</span>) </span>{
  <span class="hljs-comment">// Trivial input verification omitted</span>
  <span class="hljs-keyword">const</span> { name } = props;
  children = children.flat();

  <span class="hljs-keyword">if</span> (!children.every(<span class="hljs-function">(<span class="hljs-params">c</span>) =></span> c <span class="hljs-keyword">instanceof</span> FileSystem)) {
    <span class="hljs-keyword">const</span> msg = <span class="hljs-string">`Children of directory <span class="hljs-subst">${name}</span> must be directory or file elements`</span>;
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RoutingError(msg);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Dir(name, children);
}
</code></pre>
<p><code>createFile</code> verifies that there is only one child before creating a <code>File</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createFile</span>(<span class="hljs-params">props, children</span>) </span>{
  <span class="hljs-comment">// Trivial input verification omitted</span>
  <span class="hljs-keyword">const</span> { name } = props;

  <span class="hljs-keyword">if</span> (children.length !== <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">const</span> msg = <span class="hljs-string">`File <span class="hljs-subst">${name}</span> must have a single child element or string`</span>;
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RoutingError(msg);
  }

  <span class="hljs-keyword">const</span> [content] = children;

  <span class="hljs-keyword">if</span> (React.isValidElement(content)) {
    <span class="hljs-keyword">const</span> page = <span class="hljs-string">`&#x3C;!DOCTYPE html><span class="hljs-subst">${renderToStaticMarkup(content)}</span>`</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> File(name, page);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> File(name, content); <span class="hljs-comment">// `content` must be a string</span>
}
</code></pre>
<p>That is as much as we need to use the library successfully!</p>
<h3>Cleaning up</h3>
<p>There are a couple of improvements that we can make:</p>
<ol>
<li><code>createElement</code> should prevent children from being passed as <code>props.children</code>.</li>
<li><code>FileSystem.write</code> implementations could use the promise-based Node filesystem API.</li>
</ol>
<p>Passing children directly through props is discouraged.<sup id="fnref-5"><a href="#fn-5" class="footnote-ref">5</a></sup> It leads to quirks when children are <em>also</em> passed through composition, as the transpiler discards <code>props.children</code> when calling the JSX factory.</p>
<p>We can add the following block to <code>createDir</code> and <code>createFile</code> to prevent developers from passing children directly to <code>Dir</code> or <code>File</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">if</span> (props.children) {
  <span class="hljs-keyword">const</span> msg = <span class="hljs-string">`Contents of <span class="hljs-subst">${name}</span> must be passed as nested children`</span>;
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RoutingError(msg); <span class="hljs-comment">// Why would anyone do this?</span>
}
</code></pre>
<p>Code like</p>
<pre><code class="hljs language-jsx">&#x3C;File name=<span class="hljs-string">"about.html"</span> children={<span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">About</span> /></span></span>} /> <span class="hljs-comment">// Not OK</span>
</code></pre>
<p>will throw when executed.</p>
<p>Using callback or promise-based Node APIs to write directories and files asynchronously means we can ask the operating system to try writing all the children of a directory at once. Currently, we wait for one child to be written before we start writing the next one.<sup id="fnref-6"><a href="#fn-6" class="footnote-ref">6</a></sup></p>
<p>The simplest way to make the change is to use <code>async</code>-<code>await</code> syntax:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs/promises"</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FileSystem</span> </span>{
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">write</span>(<span class="hljs-params">rootPath</span>)</span> {
    <span class="hljs-keyword">const</span> filePath = path.join(rootPath, <span class="hljs-built_in">this</span>.name);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> fs.writeFile(filePath, <span class="hljs-built_in">this</span>.content);
    } <span class="hljs-keyword">catch</span> (_) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FileWriteError(filePath);
    }
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dir</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FileSystem</span> </span>{
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">write</span>(<span class="hljs-params">rootPath</span>)</span> {
    <span class="hljs-keyword">const</span> dirPath = path.join(rootPath, <span class="hljs-built_in">this</span>.name);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// Write the parent directory first,</span>
      <span class="hljs-keyword">await</span> fs.mkdir(dirPath, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    } <span class="hljs-keyword">catch</span> (_) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FileWriteError(dirPath);
    }
    <span class="hljs-comment">// and then all the children at once</span>
    <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(
      <span class="hljs-built_in">this</span>.content.map(<span class="hljs-function">(<span class="hljs-params">fileOrDir</span>) =></span> fileOrDir.write(dirPath))
    );
  }
}
</code></pre>
<p>If you can afford to, it is best to avoid concurrent programming.</p>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">Before the introduction of <a href="https://reactjs.org/docs/hooks-intro.html">React Hooks</a> in React 16.8, class and function components served different purposes. Now that function components can also manipulate React state through hooks, class components are somewhat redundant.<a href="#fnref-1" class="footnote-backref">↩</a></li>
<li id="fn-2">In practice, this means that user-defined React components must be named with a capital letter or be assigned to a capitalised variable before use.<a href="#fnref-2" class="footnote-backref">↩</a></li>
<li id="fn-3">Since the release of React 17, many transpilers <a href="https://reactjs.org/blog/2020/09/22/introducing-the-new-jsx-transform.html">can "automatically import" React</a>.<a href="#fnref-3" class="footnote-backref">↩</a></li>
<li id="fn-4">Fragments allow components to return multiple elements without adding extra nodes to the DOM.<a href="#fnref-4" class="footnote-backref">↩</a></li>
<li id="fn-5">This bad practice can be identified during linting; by default, the ESLint React plugin <a href="https://github.com/yannickcr/eslint-plugin-react/blob/master/docs/rules/no-children-prop.md">stops</a> children from being passed directly through props.<a href="#fnref-5" class="footnote-backref">↩</a></li>
<li id="fn-6">Building a website from a script only taxes a machine briefly anyway, so the difference in runtime shouldn't be noticeable.<a href="#fnref-6" class="footnote-backref">↩</a></li>
</ol>
</div></div></div><div class="pagination"><span class="pagination-item"><a href="/posts/create-a-class.html">Previous</a></span><span class="pagination-item"><span>Next</span></span></div></div></div></body></html>